import axios from 'axios';

const API_URL = 'http://localhost:8000/api';

// ‚úÖ Configurar axios para usar el token si est√° disponible
if (typeof window !== 'undefined') {
  const token = localStorage.getItem('auth_token');
  if (token) {
    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
  }
}

const CommunicationManager = {
  // ‚úÖ Iniciar sesi√≥n
  // ‚úÖ Iniciar sesi√≥n
async login(email, password) {
  try {
      const response = await axios.post(`${API_URL}/login`, { email, password });
      const token = response.data.token;
      const user = response.data.user;

      if (typeof window !== 'undefined' && token) {
          // Guardar el token en localStorage para futuras solicitudes
          localStorage.setItem('auth_token', token);
          axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      }

      if (typeof window !== 'undefined' && user) {
          // ‚úÖ Guardar datos importantes en localStorage
          localStorage.setItem('user', JSON.stringify(user));
          localStorage.setItem('user_id', user.id); // üèÜ Guardar el user_id directamente
          localStorage.setItem('user_name', user.name);
          localStorage.setItem('user_email', user.email);
      }

      console.log('‚úÖ Login exitoso. Usuario almacenado:', user);

      return response.data;
  } catch (error) {
      console.error('‚ùå Error al iniciar sesi√≥n:', error.response?.data?.message || error.message);
      throw new Error(error.response?.data?.message || 'Error al iniciar sesi√≥n');
  }
},


  // ‚úÖ Registrar usuario
  async register(userData) {
    try {
      const response = await axios.post(`${API_URL}/register`, userData);
      const token = response.data.token;

      if (typeof window !== 'undefined' && token) {
        localStorage.setItem('auth_token', token);
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      }

      if (typeof window !== 'undefined') {
        localStorage.setItem('user', JSON.stringify(response.data.user));
      }

      return response.data;
    } catch (error) {
      throw new Error(error.response?.data?.message || 'Error al registrar usuario');
    }
  },

  // ‚úÖ Verificar autenticaci√≥n
  async checkAuth() {
    if (typeof window === 'undefined') return false;

    const token = localStorage.getItem('auth_token');
    if (!token) return false;

    try {
      const response = await axios.get(`${API_URL}/auth/check`);
      return response.data.status === 'authenticated';
    } catch (error) {
      console.error('‚ùå Error de autenticaci√≥n:', error.message);
      this.logout();
      return false;
    }
  },

  // ‚úÖ Cierre de sesi√≥n
  logout() {
    if (typeof window !== 'undefined') {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user');
      delete axios.defaults.headers.common['Authorization'];
    }
  },

  // ‚úÖ Obtener listado de pel√≠culas
  async fetchMovies() {
    const response = await axios.get(`${API_URL}/movies`);
    return response.data;
  },

  // ‚úÖ Obtener detalles de una pel√≠cula
  async fetchMovieDetails(movieId) {
    const response = await axios.get(`${API_URL}/movies/${movieId}`);
    return response.data;
  },

  // ‚úÖ Crear pel√≠cula (solo admin)
  async createMovie(movieData) {
    const user = JSON.parse(localStorage.getItem('user'));
    if (user?.role !== 'admin') {
      throw new Error('No tienes permisos para crear pel√≠culas.');
    }
    const response = await axios.post(`${API_URL}/movies`, movieData);
    return response.data;
  },

  // ‚úÖ Actualizar pel√≠cula (solo admin)
  async updateMovie(movieId, movieData) {
    const user = JSON.parse(localStorage.getItem('user'));
    if (user?.role !== 'admin') {
      throw new Error('No tienes permisos para actualizar pel√≠culas.');
    }
    const response = await axios.put(`${API_URL}/movies/${movieId}`, movieData);
    return response.data;
  },

  // ‚úÖ Eliminar pel√≠cula (solo admin)
  async deleteMovie(movieId) {
    const user = JSON.parse(localStorage.getItem('user'));
    if (user?.role !== 'admin') {
      throw new Error('No tienes permisos para eliminar pel√≠culas.');
    }
    const response = await axios.delete(`${API_URL}/movies/${movieId}`);
    return response.data;
  },

  // ‚úÖ Obtener sesiones por ID de pel√≠cula
  async fetchSessionsByMovie(movieId) {
    const response = await axios.get(`${API_URL}/sessions/movie/${movieId}`);
    return response.data;
  },

  // ‚úÖ Obtener butacas por ID de sesi√≥n
  async fetchSeatsBySession(sessionId) {
    const response = await axios.get(`${API_URL}/seats/session/${sessionId}`);
    return response.data;
  },

  // ‚úÖ Reservar asiento (solo si hay token)
  async reserveSeat(seatId, sessionId) {
    if (!(await this.checkAuth())) {
      alert('‚ö†Ô∏è Debes iniciar sesi√≥n para reservar una butaca.');
      window.location.href = '/login';
      return;
    }

    try {
      const response = await axios.post(`${API_URL}/reserve-seat`, {
        seat_id: seatId,
        session_id: sessionId,
      });

      return response.data;
    } catch (error) {
      console.error('‚ùå Error al reservar la butaca:', error);
      throw new Error(error.response?.data?.message || 'Error al reservar la butaca');
    }
  },

  // ‚úÖ Reservar m√∫ltiples asientos
  async reserveSeats(seatIds, sessionId) {
    if (!(await this.checkAuth())) {
      alert('‚ö†Ô∏è Debes iniciar sesi√≥n para reservar butacas.');
      window.location.href = '/login';
      return;
    }

    try {
      const response = await axios.post(`${API_URL}/reservar-butacas`, {
        seat_ids: seatIds,
        session_id: sessionId,
      });

      return response.data;
    } catch (error) {
      console.error('‚ùå Error al reservar las butacas:', error);
      throw new Error(error.response?.data?.message || 'Error al reservar las butacas');
    }
  },

  async cancelReservation(seatId) {
    try {
      const response = await axios.delete(`${API_URL}/cancel-reservation/${seatId}`);
      return response.data;
    } catch (error) {
      console.error('Error al cancelar la reserva:', error);
      throw error;
    }
  },   

  // ‚úÖ Obtener historial de reservas
  async fetchReservations() {
    const response = await axios.get(`${API_URL}/reservations`);
    return response.data;
  },
  
  async fetchReservationsByUser() {
    try {
      const user = JSON.parse(localStorage.getItem('user'));
      if (!user || !user.id) {
        throw new Error('No hay usuario autenticado');
      }
  
      const response = await axios.get(`${API_URL}/reservations/user/${user.id}`);
      return response.data;
    } catch (error) {
      console.error('Error al obtener las reservas:', error);
      throw error;
    }
  },  

  // ‚úÖ Obtener precio de butaca por ID
  async getSeatPriceById(seatId) {
    const response = await axios.get(`${API_URL}/seat/price/${seatId}`);
    return response.data;
  },

  // ‚úÖ Obtener total de compra por usuario
  async getTotalPriceByUser(userId) {
    const response = await axios.get(`${API_URL}/compras/total/${userId}`);
    return response.data;
  },

  // ‚úÖ Obtener fecha de sesi√≥n por ID de pel√≠cula
  async getSessionDateByMovieId(movieId) {
    const response = await axios.get(`${API_URL}/sessions/date/${movieId}`);
    return response.data;
  },

  // ‚úÖ Completar reserva
  async completeReservation(reservationData) {
    const response = await axios.post(`${API_URL}/reservar-completa`, reservationData);
    return response.data;
  },

  // ‚úÖ Obtener configuraci√≥n base de la API
  getApiBase() {
    return API_URL;
  },

  // ‚úÖ Obtener headers de autorizaci√≥n
  getAuthHeaders() {
    if (typeof window !== 'undefined') {
      const token = localStorage.getItem('auth_token');
      return token ? { Authorization: `Bearer ${token}` } : {};
    }
    return {};
  },
};

export default CommunicationManager;
